# AMOCRM-Integration

Интеграция с **amoCRM** для приёма вебхуков по контактам и сделкам, хранения их в MySQL и предоставления API для отладки.

---

## 📈 Возможности

* ✨ Приём вебхуков amoCRM (`/webhooks`) для событий **add** и **update** по контактам и сделкам.
* 🛠️ Автоматическая нормализация телефонов и сохранение email.
* 🔗 Синхронизация связей между сделками и контактами.
* 📂 SQL-миграции для создания структуры БД.
* 🔍 Отладочные эндпоинты для просмотра данных в БД.

---

## ⚙️ Установка и запуск

### 1. Клонируем репозиторий

```bash
git clone https://github.com/HastG99/AMOCRM-Integration.git
cd AMOCRM-Integration
```

### 2. Устанавливаем зависимости

```bash
npm install
```

### 3. Создаём файл окружения

В корне проекта создайте файл **.env** по примеру:

```env
# Порт для запуска сервера
PORT=3000

# Настройки подключения к MySQL
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=amocrm_test
DB_CONNECTION_LIMIT=10
```

---

## 🗄️ Настройка базы данных

1. Убедитесь, что у вас установлен и запущен MySQL.
2. Создайте базу данных:

```sql
CREATE DATABASE amocrm_test;
```

3. Запустите миграции:

```bash
npm run migrate
```

---

## 🚀 Запуск проекта

### Обычный запуск

```bash
npm start
```

### Запуск в режиме разработки (с авто-перезапуском)

```bash
npm run dev
```

После запуска сервер будет доступен по адресу:

```
http://localhost:3000
```

---

## 🔌 API эндпоинты

### Health-check

```
GET /health
```

Ответ:

```json
{ "ok": true }
```

### Отладка — список контактов

```
GET /debug/contacts
```

### Отладка — список сделок

```
GET /debug/deals
```

### Отладка — контакты сделки

```
GET /debug/deals/:id/contacts
```

### Приём вебхуков

```
POST /webhooks
```

Тело запроса (пример):

```json
{
  "contacts": {
    "add": [{
      "id": 5001,
      "name": "Тест Контакт",
      "custom_fields": [{
        "code": "PHONE",
        "values": [{"value": "+79160000001"}]
      }]
    }]
  }
}
```

---

## 🤖 Тестирование

### Проверка подключения к БД

```bash
npm run test-conn
```

### Отправка тестового вебхука

```bash
bash scripts/test_webhooks.sh
```

---

## 📂 Структура проекта

```
AmoCRMIntegration
├── app.js                # Точка входа
├── controllers           # Контроллеры (логика обработки запросов)
├── migrations            # SQL-миграции
├── models                # Подключение к БД
├── repositories          # Репозитории (доступ к данным)
├── scripts               # Скрипты для миграций и тестирования
├── services              # Бизнес-логика
└── README.md             # Документация
```

---

## 🛠️ Требования

* Node.js **>=16**
* MySQL **>=5.7**
* npm **>=6**

---